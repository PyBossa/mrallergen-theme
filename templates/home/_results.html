{% extends "base.html" %}
{% set active_page = "results" %}

{% block content %}
<section class="results">
    <div class="container">
        <div class="row jumbotron-search">
            <div class="col-xs-12 col-md-12 text-center">
                <h1>Buscador de productos</h1>
                <div class="row search-group">
                    <div class="col-xs-12 col-sm-6 col-sm-offset-1 col-md-offset-2 col-md-5">
                        <input type="text" class="input-group-lg form-control" placeholder="¿Qué buscas?">
                    </div>
                    <div class="col-xs-12 col-sm-4 col-md-3">
                        <a id="search" src="#" class="btn btn-primary btn-search">Buscar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="found">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-8">
                <p class="n-products-found"><span id="n_results">0</span> resultados para "<span id="search_term"></span>"</p>
            </div>
            <div class="col-xs-12 col-sm-4">
                <!-- Single button -->
                <div class="btn-group pull-right">
                    <button id="default-option" type="button" class="btn btn-options dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Todos los productos <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a id="dropdown-gluten-free" href="#">Sin gluten</a></li>
                        <li><a id="dropdown-wheat" href="#">Trigo o trazas</a></li>
                        <li><a id="dropdown-all" href="#">Todos los productos</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row products"></div>
    </div>
</div>
</section>
<section class="selected-product">
<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <a href="#" id="back"><i class="fa  fa-lg fa-chevron-left"></i> Atrás</a>
        </div>
    </div>
</div>
</section>
{% endblock %}

{% block extrajs %}
<script>
console.log($("#search").attr("id"));
$("input").keyup(function(event){
        if(event.keyCode == 13){
        $("#search").click();
        }
        });


$("#dropdown-wheat").off('click').on('click', function(){
        var html = $("#dropdown-wheat").text() + ' <span class="caret"></span>';
        $("#default-option").html(html);
        $(".div-product").hide();
        $(".div-product.wheat").show();
        $("#n_results").text($(".div-product.wheat").length);
        }); 

$("#dropdown-gluten-free").off('click').on('click', function(){
        var html = $("#dropdown-gluten-free").text() + ' <span class="caret"></span>';
        $("#default-option").html(html);
        $(".div-product").hide();
        $(".div-product.gluten-free").show();
        $("#n_results").text($(".div-product.gluten-free").length);
        }); 

$("#dropdown-all").off('click').on('click', function(){
        var html = $("#dropdown-all").text() + ' <span class="caret"></span>';
        $("#default-option").html(html);
        $(".div-product").show();
        $("#n_results").text($(".div-product").length);
        }); 

$("#back").off('click').on('click', function(){
        $(".row.products").show();
        $(".found").show();
        $(".selected-product").hide();
        var id = $("#back").data("close");
        $("#" + id + "-big").hide();
        });


$("#search").off('click').on('click', function(){
        var data = $("input").val();
        data = data.replace(/ +/g, ' ');
        data = data.replace(/^ /gi, "");
        data = data.replace(/ $/gi, "");
        console.log(data);
        if ((data.match(/ /g) || []).length >= 1) {
        var query = data.replace(/ /g, '%26');
        }
        else {
        var query = data.replace(/ /g, '');
        }
        $.ajax({
url: "/api/result?project_id=3292&info=name::" + query + "&fulltextsearch=1",
})
        .done(function( data ) {
            if ( console && console.log ) {
            console.log( "Sample of data:", data.slice( 0, 100 ) );
            $(".row.products").html("");
            $(".row.selected").remove();
            $(".found").show();
            $("#n_results").text(data.length);
            $("#search_term").text($("input").val());

            if (data.length > 0) {
            for (i=0; i<data.length;i++) {
            var col = $("<div/>");
            col.addClass("col-xs-12 col-sm-6 col-md-4 col-lg-3 div-product");
            var product = $("<div/>");
            product.attr("id", "product-" + i);
            product.addClass("product");
            var brand = $("</p>");
            brand.addClass("brand");
            var name = $("</p>");
            name.addClass("name");
            var labels = $("</p>");
            if (data[i]['info']['labelGlutenFree'] === 'yes') {
                var iconGlutenFree = $("<img>");
                iconGlutenFree.attr("src", "/static/img/green-gluten.svg");
                labels.text(" Sin gluten");
                labels.prepend(iconGlutenFree);
                labels.addClass("gluten-free");
                col.addClass("gluten-free ");
                labels.addClass("classification-label");
            }

            if (data[i]['info']['ingredientsWheat'] === 'yes') {
                var iconWheat = $("<img>");
                iconWheat.attr("src", "/static/img/red-gluten.svg");
                labels.text(" Trigo o trazas");
                labels.prepend(iconWheat);
                labels.addClass("wheat");
                col.addClass("wheat");
            }


            product.append(brand);
            product.append(name);
            product.append(labels);

            var divImg = $("<div/>");
            divImg.addClass("img-vertical-centered");
            var productImg = $("<img/>");
            productImg.attr("src", data[i]['info']['productImg']);
            productImg.addClass("img img-responsive");
            divImg.append(productImg);

            name.text(data[i]['info']['name']);
            product.append(divImg);
            col.append(product);
            $(".row.products").append(col);


            // SELECTED PRODUCT CREATION
            var row = $("<div/>");
            row.addClass("row selected");
            row.attr("id", "product-" + i + "-big");
            var colImg = $("<div/>");
            colImg.addClass("col-xs-6");
            var colData = $("<div/>");
            colData.addClass("col-xs-6");

            var square = $("<div/>");
            square.addClass("square");
            var productImgBig = $("<img/>");
            productImgBig.attr("src", data[i]['info']['productImg']);
            productImgBig.addClass("img-responsive img");

            square.append(productImgBig);
            colImg.append(square);

            var aBrand = $("<a/>");
            aBrand.text("");
            colData.append(aBrand);

            var nameBig = $("</p>");
            nameBig.addClass("name");
            nameBig.text(data[i]['info']['name']);

            colData.append(nameBig);

            var classification = $("<div/>");
            classification.addClass("classification");
            var labelsBig = $("</p>");
            if (data[i]['info']['labelGlutenFree'] === 'yes') {
                var iconGlutenFree = $("<img>");
                iconGlutenFree.attr("src", "/static/img/green-gluten.svg");
                labelsBig.text(" Sin gluten");
                labelsBig.prepend(iconGlutenFree);
                labelsBig.addClass("gluten-free");
                classification.addClass("gluten-free");
                col.addClass("gluten-free");
            }

            if (data[i]['info']['ingredientsWheat'] === 'yes') {
                var iconWheat = $("<img>");
                iconWheat.attr("src", "/static/img/red-gluten.svg");
                labelsBig.text(" Trigo o trazas");
                labelsBig.prepend(iconWheat);
                labelsBig.addClass("wheat");
                classification.addClass("wheat");
                col.addClass("wheat");
            }

            classification.append(labelsBig);
            var explanation = $("<p/>");
            if (data[i]['info']['labelGlutenFree'] === 'yes') {
                var n_people = data[i]['info']['labelGlutenFreeSummary']['count'];
            }
            if (data[i]['info']['ingredientsWheat'] === 'yes') {
                var n_people = data[i]['info']['ingredientsWheatSummary']['count'];
            }
            explanation.text(n_people + " personas han revisado este producto y lo han clasificado así");
            classification.append(explanation);

            colData.append(classification);

            var link = $("<a/>");
            link.addClass("btn btn-primary");
            link.attr("href", data[i]['info']['url']);
            link.text("Ver en Soysuper");

            colData.append(link);
            row.append(colImg);
            row.append(colData);
            $(".selected-product > .container").append(row);

            $(".product").off('click').on('click', function(event){
                    var id = $(this).attr("id");
                    $(".row.products").hide();
                    $(".found").hide();
                    $(".selected-product").show();
                    $("#" + id + "-big").show();
                    $("#back").data("close", id);
                    });
            }


            }
            else {
                var p = $("</p>");
                p.text("No results");
                $("#searchresults").append(p);
            }

            }
        });
});
</script>
{% endblock %}

