{% extends "base.html" %}
{% set active_page = "results" %}

{% block content %}
<section class="results">
    <div class="container">
        <div class="row jumbotron-search">
            <div class="col-xs-12 col-md-12 text-center">
                <h1>Buscador de productos</h1>
                <div class="row">
                    <div class="col-xs-4 col-xs-offset-3">
                        <input type="text" class="input-group-lg form-control" placeholder="¿Qué buscas?">
                    </div>
                    <div class="col-xs-2">
                        <a id="search" src="#" class="btn btn-primary btn-search">Buscar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="found">
    <div class="container">
        <div class="row">
            <div class="col-xs-6">
                <p class="n-products-found"><span id="n_results">0</span> productos para "<span id="search_term"></span>"</p>
            </div>
            <div class="col-xs-6">
                <!-- Single button -->
                <div class="btn-group pull-right">
                  <button type="button" class="btn btn-options dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Todos los productos<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a href="#">Sin gluten</a></li>
                    <li><a href="#">Trigo o trazas</a></li>
                  </ul>
                </div>
            </div>
        </div>
        <div class="row products">
                <div class="col-xs-3">
                    <div class="product">
                        <p class="brand">Eagle</p>
                        <p class="name">Cacahuetes</p>
                        <p class="gluten-free"><img src="http://placehold.it/16x16">Sin gluten</p>
                        <img class="center-block img" src="http://placehold.it/100x100">
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="product">
                        <p class="brand">Eagle</p>
                        <p class="name">Cacahuetes</p>
                        <p class="gluten-free"><img src="http://placehold.it/16x16">Sin gluten</p>
                        <img class="center-block img" src="http://placehold.it/100x100">
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="product">
                        <p class="brand">Eagle</p>
                        <p class="name">Cacahuetes</p>
                        <p class="gluten-free"><img src="http://placehold.it/16x16">Sin gluten</p>
                        <img class="center-block img" src="http://placehold.it/100x100">
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="product">
                        <p class="brand">Eagle</p>
                        <p class="name">Cacahuetes</p>
                        <p class="gluten-free"><img src="http://placehold.it/16x16">Sin gluten</p>
                        <img class="center-block img" src="http://placehold.it/100x100">
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extrajs %}
<script>
   console.log($("#search").attr("id"));
    $("input").keyup(function(event){
        if(event.keyCode == 13){
            $("#search").click();
        }
    });


    $("#search").off('click').on('click', function(){
            var data = $("input").val();
            data = data.replace(/ +/g, ' ');
            data = data.replace(/^ /gi, "");
            data = data.replace(/ $/gi, "");
            console.log(data);
            if ((data.match(/ /g) || []).length >= 1) {
                var query = data.replace(/ /g, '%26');
    }
            else {
                var query = data.replace(/ /g, '');
            }
        $.ajax({
          url: "/api/result?project_id=3292&info=name::" + query + "&fulltextsearch=1",
        })
          .done(function( data ) {
            if ( console && console.log ) {
              console.log( "Sample of data:", data.slice( 0, 100 ) );
              $(".row.products").html("");


              if (data.length > 0) {
              $("#n_results").text(data.length);
              $("#search_term").text($("input").val());
              for (i=0; i<data.length;i++) {
                    var col = $("<div/>");
                    col.addClass("col-xs-3");
                    var product = $("<div/>");
                    product.addClass("product");
                    var brand = $("</p>");
                    brand.addClass("brand");
                    var name = $("</p>");
                    name.addClass("name");
                    var labels = $("</p>");
                    if (data[i]['info']['labelGlutenFree'] === 'yes') {
                        var iconGlutenFree = $("<img>");
                        iconGlutenFree.attr("src", "http://placehold.it/16x16");
                        labels.text(" Sin gluten");
                        labels.prepend(iconGlutenFree);
                        labels.addClass("gluten-free");
                    }

                    if (data[i]['info']['ingredientsWheat'] === 'yes') {
                        var iconWheat = $("<img>");
                        iconWheat.attr("src", "http://placehold.it/16x16");
                        labels.text(" Trigo o trazas");
                        labels.prepend(iconWheat);
                        labels.addClass("wheat");
                    }


                    product.append(brand);
                    product.append(name);
                    product.append(labels);

                    var productImg = $("<img/>");
                    productImg.attr("src", "http://placehold.it/100x100");
                    productImg.addClass("center-block img");

                    name.text(data[i]['info']['name']);
                    product.append(productImg);
                    col.append(product);
                    $(".row.products").append(col);
              }

              }
              else {
                var p = $("</p>");
                p.text("No results");
                $("#searchresults").append(p);
            }
                          
            }
          });
            });
</script>
{% endblock %}

